<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Fake DAQ for NEESgrid: fake_daq.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a></div>
<h1>fake_daq.c</h1><a href="fake__daq_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 
00029 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00030 <span class="preprocessor">#include &lt;sys/socket.h&gt;</span>
00031 <span class="preprocessor">#include &lt;netinet/in.h&gt;</span>
00032 <span class="preprocessor">#include &lt;arpa/inet.h&gt;</span>
00033 <span class="preprocessor">#include &lt;netdb.h&gt;</span>
00034 
00035 <span class="preprocessor">#include &lt;assert.h&gt;</span>
00036 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00037 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00038 <span class="preprocessor">#include &lt;math.h&gt;</span>
00039 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
00040 <span class="preprocessor">#include &lt;stdint.h&gt;</span>
00041 <span class="preprocessor">#include &lt;string.h&gt;</span>
00042 <span class="preprocessor">#include &lt;signal.h&gt;</span>
00043 <span class="preprocessor">#include &lt;time.h&gt;</span>
00044 <span class="preprocessor">#include &lt;pthread.h&gt;</span>
00045 <span class="preprocessor">#include &lt;getopt.h&gt;</span>
00046 
00047 <span class="preprocessor">#include "nsds_util.h"</span>
00048 <span class="preprocessor">#include "flog.h"</span>
00049 
00050 <span class="comment">// ---------------------------------------------------------------------</span>
00051 <span class="comment">// Globals</span>
00052 
<a name="l00054"></a><a class="code" href="fake__daq_8c.html#a0">00054</a> <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="fake__daq_8c.html#a0">DAQ_PORT</a> = 55055;
00055 
<a name="l00057"></a><a class="code" href="fake__daq_8c.html#a1">00057</a> <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="fake__daq_8c.html#a1">TCP_Q_LEN</a> = 1;
00058 
<a name="l00060"></a><a class="code" href="fake__daq_8c.html#a2">00060</a> <span class="keywordtype">bool</span> <a class="code" href="fake__daq_8c.html#a2">control_break</a>;
00061 
<a name="l00063"></a><a class="code" href="fake__daq_8c.html#a3">00063</a> <span class="keywordtype">float</span> <a class="code" href="fake__daq_8c.html#a3">sample_rate</a>;
00064 
<a name="l00066"></a><a class="code" href="fake__daq_8c.html#a4">00066</a> <span class="keywordtype">bool</span> <a class="code" href="fake__daq_8c.html#a4">streaming_active</a>;
00067 
<a name="l00069"></a><a class="code" href="fake__daq_8c.html#a5">00069</a> <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="fake__daq_8c.html#a5">SINE_PERIOD</a> = 80*NUM_CHANNELS;
00070 
00072 <span class="keyword">struct</span>
00073 <span class="keyword"></span>{
00074     pthread_mutex_t   mutex;               
<a name="l00075"></a><a class="code" href="fake__daq_8c.html#a7">00075</a>     <span class="keywordtype">bool</span>              <a class="code" href="fake__daq_8c.html#a7">active</a>[NUM_CHANNELS];
00076     <span class="keywordtype">int</span>               num_active;
00077 } <a class="code" href="fake__daq_8c.html#a9">chan_struct</a>;
00078 
<a name="l00080"></a><a class="code" href="structconnection__fds.html">00080</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>
00081 <span class="keyword"></span>{
<a name="l00083"></a><a class="code" href="structconnection__fds.html#o0">00083</a>     <span class="keywordtype">int</span>    control_socket;
<a name="l00085"></a><a class="code" href="structconnection__fds.html#o1">00085</a>     <span class="keywordtype">int</span>    data_socket;
00086 } <a class="code" href="structconnection__fds.html">connection_fds</a>;
00087 
<a name="l00089"></a><a class="code" href="fake__daq_8c.html#a10">00089</a> <a class="code" href="structconnection__fds.html">connection_fds</a> <a class="code" href="fake__daq_8c.html#a10">curr_connection</a>;
00090 
00091 <span class="comment">// ---------------------------------------------------------------------</span>
<a name="l00097"></a><a class="code" href="fake__daq_8c.html#a11">00097</a> <span class="comment"></span><span class="keywordtype">int</span> <a class="code" href="fake__daq_8c.html#a11">data_active_count</a>(<span class="keywordtype">void</span>)
00098 {
00099     <span class="keywordtype">char</span>         me[] = <span class="stringliteral">"data_active_count"</span>;
00100     <span class="keywordtype">int</span>          rc;
00101     <span class="keywordtype">int</span>          count;
00102     
00103     <span class="comment">// This should be unthinkable, check anyway</span>
00104     rc = pthread_mutex_lock(&amp;<a class="code" href="fake__daq_8c.html#a9">chan_struct</a>.mutex);
00105     <span class="keywordflow">if</span>(rc != 0)
00106     {
00107     flog_usr(FLOG_ERROR, FL_ERR_MUTEX_FAILURE, me,
00108          <span class="stringliteral">"Error locking mutex!"</span>);
00109     <span class="keywordflow">return</span>(-1);
00110     }
00111 
00112     <span class="comment">// Copy data</span>
00113     count = <a class="code" href="fake__daq_8c.html#a9">chan_struct</a>.num_active;
00114     
00115     rc = pthread_mutex_unlock(&amp;<a class="code" href="fake__daq_8c.html#a9">chan_struct</a>.mutex);
00116     <span class="keywordflow">if</span>(rc != 0)
00117     flog_usr(FLOG_ERROR, FL_ERR_MUTEX_FAILURE, me,
00118          <span class="stringliteral">"Error unlocking mutex!"</span>);
00119     
00120     <span class="keywordflow">return</span>(count);
00121 }
00122     
00123 <span class="comment">// ---------------------------------------------------------------------</span>
<a name="l00134"></a><a class="code" href="fake__daq_8c.html#a12">00134</a> <span class="comment"></span><span class="keywordtype">bool</span> <a class="code" href="fake__daq_8c.html#a12">data_channel_enabled</a>(<span class="keyword">const</span> <span class="keywordtype">int</span> channel_id)
00135 {
00136     <span class="keywordtype">char</span>   me[] = <span class="stringliteral">"data_channel_enabled"</span>;
00137     <span class="keywordtype">int</span>    rc;
00138     <span class="keywordtype">bool</span>   is_act = <span class="keyword">false</span>;
00139     
00140     <span class="comment">// Range check</span>
00141     <span class="keywordflow">if</span>((channel_id &lt; 0) || (channel_id &gt;= NUM_CHANNELS))
00142     {
00143     flog_usr(FLOG_ERROR, FL_ERR_BAD_PARAM, me,
00144          <span class="stringliteral">"Error, invalid channel ID %d"</span>, channel_id);
00145     <span class="keywordflow">return</span>(<span class="keyword">false</span>);
00146     }
00147 
00148     <span class="comment">// This should be unthinkable, check anyway</span>
00149     rc = pthread_mutex_lock(&amp;<a class="code" href="fake__daq_8c.html#a9">chan_struct</a>.mutex);
00150     <span class="keywordflow">if</span>(rc != 0)
00151     {
00152     flog_usr(FLOG_ERROR, FL_ERR_MUTEX_FAILURE, me,
00153          <span class="stringliteral">"Error locking mutex!"</span>);
00154     <span class="keywordflow">return</span>(<span class="keyword">false</span>);
00155     }
00156 
00157     is_act = <a class="code" href="fake__daq_8c.html#a9">chan_struct</a>.active[channel_id];
00158     
00159     rc = pthread_mutex_unlock(&amp;<a class="code" href="fake__daq_8c.html#a9">chan_struct</a>.mutex);
00160     <span class="keywordflow">if</span>(rc != 0)
00161     flog_usr(FLOG_ERROR, FL_ERR_MUTEX_FAILURE, me,
00162          <span class="stringliteral">"Error unlocking mutex!"</span>);
00163     
00164     <span class="keywordflow">return</span>(is_act);
00165 }
00166 
00167 <span class="comment">// ---------------------------------------------------------------------</span>
<a name="l00180"></a><a class="code" href="fake__daq_8c.html#a13">00180</a> <span class="comment"></span><span class="keywordtype">int</span> <a class="code" href="fake__daq_8c.html#a13">data_channel_flag</a>(<span class="keyword">const</span> <span class="keywordtype">int</span> channel_id, <span class="keyword">const</span> <span class="keywordtype">bool</span> subscribe)
00181 {
00182     <span class="keywordtype">char</span>      me[] = <span class="stringliteral">"data_channel_flag"</span>;
00183     <span class="keywordtype">int</span>       rc;
00184     <span class="keywordtype">bool</span>      old_setting;
00185     
00186     <span class="comment">// Range check</span>
00187     <span class="keywordflow">if</span>((channel_id &lt; 0) || (channel_id &gt;= NUM_CHANNELS))
00188     {
00189     flog_usr(FLOG_ERROR, FL_ERR_BAD_PARAM, me,
00190          <span class="stringliteral">"Error, invalid channel ID %d"</span>, channel_id);
00191     <span class="keywordflow">return</span>(-1);
00192     }
00193 
00194     <span class="comment">// This should be unthinkable, check anyway</span>
00195     rc = pthread_mutex_lock(&amp;<a class="code" href="fake__daq_8c.html#a9">chan_struct</a>.mutex);
00196     <span class="keywordflow">if</span>(rc != 0)
00197     {
00198     flog_usr(FLOG_ERROR, FL_ERR_MUTEX_FAILURE, me,
00199          <span class="stringliteral">"Error locking mutex!"</span>);
00200     <span class="keywordflow">return</span>(rc);
00201     }
00202 
00203     <span class="comment">// Save old</span>
00204     old_setting = <a class="code" href="fake__daq_8c.html#a9">chan_struct</a>.active[channel_id];
00205     
00206     <span class="comment">// Flag as requested - idempotent</span>
00207     <a class="code" href="fake__daq_8c.html#a9">chan_struct</a>.active[channel_id] = subscribe;
00208     
00209     <span class="comment">// If setting has changed, update counts</span>
00210     <span class="keywordflow">if</span>(subscribe != old_setting)
00211     {
00212     <span class="keywordflow">if</span>(subscribe)
00213         <a class="code" href="fake__daq_8c.html#a9">chan_struct</a>.num_active++;
00214     <span class="keywordflow">else</span>
00215         <a class="code" href="fake__daq_8c.html#a9">chan_struct</a>.num_active--;
00216     
00217     <span class="keywordflow">if</span>(<a class="code" href="fake__daq_8c.html#a9">chan_struct</a>.num_active &lt; 0)
00218     {
00219         flog_usr(FLOG_ERROR, FL_ERR_NOCANDO, me,
00220              <span class="stringliteral">"Underflow in active channel count; code error!"</span>);
00221         <a class="code" href="fake__daq_8c.html#a9">chan_struct</a>.num_active = 0;
00222     }
00223     
00224     <span class="keywordflow">if</span>(<a class="code" href="fake__daq_8c.html#a9">chan_struct</a>.num_active &gt; NUM_CHANNELS)
00225     {
00226         flog_usr(FLOG_ERROR, FL_ERR_NOCANDO, me,
00227              <span class="stringliteral">"Overflow in active channel count; code error!"</span>);
00228         <a class="code" href="fake__daq_8c.html#a9">chan_struct</a>.num_active = (NUM_CHANNELS - 1);
00229     }
00230     }
00231     
00232     rc = pthread_mutex_unlock(&amp;<a class="code" href="fake__daq_8c.html#a9">chan_struct</a>.mutex);
00233     <span class="keywordflow">if</span>(rc != 0)
00234     {
00235     flog_usr(FLOG_ERROR, FL_ERR_MUTEX_FAILURE, me,
00236          <span class="stringliteral">"Error unlocking mutex!"</span>);
00237     <span class="keywordflow">return</span>(rc);
00238     }
00239 
00240     <span class="comment">// DDT, once mutex released</span>
00241     <span class="keywordflow">if</span>((subscribe) &amp;&amp; (old_setting != subscribe))
00242     {
00243     flog_usr(FLOG_L2BUG, 0, me,
00244          <span class="stringliteral">"Channel %d marked as active"</span>, channel_id);
00245     }
00246     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(old_setting != subscribe)
00247     {
00248     flog_usr(FLOG_L2BUG, 0, me,
00249          <span class="stringliteral">"Channel %d marked as inactive"</span>, channel_id);
00250     }
00251     
00252     <span class="keywordflow">return</span>(0);
00253 }
00254 
00255 <span class="comment">// ---------------------------------------------------------------------</span>
<a name="l00263"></a><a class="code" href="fake__daq_8c.html#a14">00263</a> <span class="comment"></span><span class="keywordtype">double</span> <a class="code" href="fake__daq_8c.html#a14">data_generate</a>(<span class="keyword">const</span> <span class="keywordtype">int</span> index, <span class="keyword">const</span> <span class="keywordtype">double</span> sin_period)
00264 {
00265     <span class="keywordtype">double</span>    t_arg = 0.0;
00266     <span class="keywordtype">double</span>    t_per = 0.0;
00267     
00268     <span class="comment">// Almost useless, this</span>
00269     assert(sin_period != 0.0);
00270     
00271     <span class="comment">// Scale index to period of function - this yields [0,1]</span>
00272     t_per = (<span class="keywordtype">double</span>) index / sin_period;
00273     
00274     <span class="comment">// Map index onto [0.0, 2*pi]</span>
00275     t_arg = t_per * 2.0 * M_PI;
00276     
00277     <span class="keywordflow">return</span>(sin(t_arg));
00278 }
00279     
00280 <span class="comment">// ---------------------------------------------------------------------</span>
<a name="l00288"></a><a class="code" href="fake__daq_8c.html#a15">00288</a> <span class="comment"></span><span class="keywordtype">void</span> <a class="code" href="fake__daq_8c.html#a15">sighandler</a>(<span class="keywordtype">int</span> signal)
00289 {
00290     <span class="keywordtype">char</span>    me[] = <span class="stringliteral">"sighandler"</span>;
00291 
00292     flog_usr(FLOG_NOTICE, 0, me, <span class="stringliteral">"Got signal %d, closing network and exiting"</span>, 
00293          signal);
00294     <a class="code" href="fake__daq_8c.html#a2">control_break</a> = <span class="keyword">true</span>;
00295 
00296     <span class="comment">// New 9/2/03, force a quit to propagate</span>
00297     shutdown(<a class="code" href="fake__daq_8c.html#a10">curr_connection</a>.<a class="code" href="structconnection__fds.html#o0">control_socket</a>, SHUT_RDWR);
00298     shutdown(<a class="code" href="fake__daq_8c.html#a10">curr_connection</a>.<a class="code" href="structconnection__fds.html#o1">data_socket</a>, SHUT_RDWR);
00299     close(<a class="code" href="fake__daq_8c.html#a10">curr_connection</a>.<a class="code" href="structconnection__fds.html#o0">control_socket</a>);
00300     close(<a class="code" href="fake__daq_8c.html#a10">curr_connection</a>.<a class="code" href="structconnection__fds.html#o1">data_socket</a>);
00301 
00302     <span class="keywordflow">return</span>;
00303 }
00304 
00305 <span class="comment">// ---------------------------------------------------------------------</span>
<a name="l00317"></a><a class="code" href="fake__daq_8c.html#a16">00317</a> <span class="comment"></span><span class="keywordtype">void</span> *<a class="code" href="fake__daq_8c.html#a16">data_thread_main</a>(<span class="keywordtype">void</span> *arg)
00318 {
00319     <span class="keywordtype">char</span>          me[] = <span class="stringliteral">"data_thread_main"</span>;
00320     <span class="keywordtype">int</span>           *iptr = (<span class="keywordtype">int</span> *) arg;
00321     <span class="keywordtype">int</span>           data_socket;
00322     uint32_t      idx = 0;
00323     uint32_t      data_idx = 0;
00324     uint32_t      byte_count = 0;
00325     <span class="keywordtype">char</span>          *data_buf = NULL;
00326     <span class="keywordtype">char</span>          datum_buf[DATUM_LEN] = <span class="stringliteral">""</span>;
00327     <span class="keywordtype">int</span>           bufsize;
00328     <span class="keywordtype">double</span>        data[<a class="code" href="fake__daq_8c.html#a5">SINE_PERIOD</a>];
00329     <span class="keywordtype">int</span>           rc;
00330     <span class="keywordtype">int</span>           sample_delay = 50000; <span class="comment">// 20Hz, 5e4</span>
00331     time_t        t_start, t_delta;
00332     <span class="keywordtype">int</span>           ipos = 0;
00333     <span class="keywordtype">int</span>           jpos;
00334         
00335     <span class="comment">// Check argument</span>
00336     <span class="keywordflow">if</span>(iptr == NULL)
00337     {
00338     flog_usr(FLOG_ERROR, FL_ERR_NULL_PTR, me, <span class="stringliteral">"Null pointer to thread!"</span>);
00339     <span class="keywordflow">return</span>(NULL);
00340     }
00341 
00342     <span class="comment">// Figure space required</span>
00343     bufsize = (4 * <span class="keyword">sizeof</span>(<span class="keywordtype">char</span>) * NUM_CHANNELS * (TSTAMP_LEN + DATUM_LEN + 4));
00344 
00345     <span class="comment">// Allocate send buffer</span>
00346     data_buf = (<span class="keywordtype">char</span> *) malloc(bufsize);
00347     <span class="keywordflow">if</span>(data_buf == NULL)
00348     {
00349     flog_usr(FLOG_ERROR, FL_ERR_NO_MEMORY, me,
00350          <span class="stringliteral">"Malloc failure on %d bytes!"</span>, bufsize);
00351 
00352     <span class="comment">// Clear flags</span>
00353     <a class="code" href="fake__daq_8c.html#a4">streaming_active</a> = <span class="keyword">false</span>;
00354 
00355     <span class="keywordflow">return</span>(NULL);
00356     }
00357 
00358     <span class="comment">// New 12/5/02, precalculate data</span>
00359     <span class="keywordflow">for</span>(idx = 0; idx &lt; <a class="code" href="fake__daq_8c.html#a5">SINE_PERIOD</a>; idx++)
00360     data[idx] = <a class="code" href="fake__daq_8c.html#a14">data_generate</a>(idx, <a class="code" href="fake__daq_8c.html#a5">SINE_PERIOD</a>);
00361     
00362     <span class="comment">// If user set sample rate, let it override default</span>
00363     <span class="comment">// Limit to 100KHz, its a sanity thing.</span>
00364     <span class="keywordflow">if</span>((<a class="code" href="fake__daq_8c.html#a3">sample_rate</a> &gt; 0) &amp;&amp; (<a class="code" href="fake__daq_8c.html#a3">sample_rate</a> &lt; 100000))
00365     {
00366     <span class="comment">// Hz to microseconds conversion</span>
00367     sample_delay = (<span class="keywordtype">int</span>) (1000000.0 / <a class="code" href="fake__daq_8c.html#a3">sample_rate</a>);
00368     }
00369     
00370     <span class="comment">// Save args into local variable, just in case</span>
00371     data_socket = *iptr;
00372 
00373     flog_usr(FLOG_NOTICE, 0, me, <span class="stringliteral">"Data thread running, %d Hz, %d usec delay"</span>, 
00374          <a class="code" href="fake__daq_8c.html#a3">sample_rate</a>, sample_delay);
00375 
00376     <span class="comment">// Note the time we started running, used for rate calculations</span>
00377     t_start = time(NULL);
00378 
00379     <span class="comment">// Run until port closed, error, control-c or done streaming</span>
00380     <span class="keywordflow">while</span>((<a class="code" href="fake__daq_8c.html#a4">streaming_active</a>) &amp;&amp; (!<a class="code" href="fake__daq_8c.html#a2">control_break</a>))
00381     {
00382     <span class="comment">// If no channels open, sleep and re-loop</span>
00383     <span class="keywordflow">if</span>(<a class="code" href="fake__daq_8c.html#a11">data_active_count</a>() &lt;= 0)
00384     {
00385         usleep(sample_delay);
00386         <span class="keywordflow">continue</span>;
00387     }
00388 
00389     <span class="comment">// DDT zero the buffer</span>
00390     memset(data_buf, 0x00, (size_t) bufsize);
00391 
00392     <span class="comment">// Start buffer off with timestamp</span>
00393     strcpy(data_buf, gen_timestamp());
00394 
00395     <span class="comment">// Loop over channels, appending subscribed ones</span>
00396     <span class="keywordflow">for</span>(idx = 0; idx &lt; NUM_CHANNELS; idx++)
00397     {
00398         <span class="keywordflow">if</span>(<a class="code" href="fake__daq_8c.html#a12">data_channel_enabled</a>(idx))
00399         {
00400         <span class="comment">// Format it up, NSDS-style, i.e. channel# / value</span>
00401         <span class="comment">// More specs online; check the webpage</span>
00402         jpos = ( ipos * (NUM_CHANNELS - idx) ) % <a class="code" href="fake__daq_8c.html#a5">SINE_PERIOD</a>;
00403         sprintf(datum_buf, <span class="stringliteral">"\t%d\t%f"</span>, idx, data[jpos]);
00404 
00405         <span class="comment">// Append to send buffer</span>
00406         strcat(data_buf, datum_buf);
00407         }
00408         }
00409 
00410     <span class="comment">// Sine wraparound</span>
00411     ipos = (ipos + 1) % <a class="code" href="fake__daq_8c.html#a5">SINE_PERIOD</a>;
00412         
00413     <span class="comment">// Send it off</span>
00414     rc = tcp_nl_write(data_socket, data_buf);
00415     <span class="keywordflow">if</span>(rc != strlen(data_buf))
00416     {
00417         flog_usr(FLOG_ERROR, FL_ERR_TRANSCEIVE, me,
00418              <span class="stringliteral">"Error sending data, short write"</span>);
00419         <span class="keywordflow">goto</span> thread_bailout;
00420     }
00421 
00422     <span class="comment">// Just in case, check for buffer overrun.</span>
00423     assert(rc &lt;= bufsize);
00424 
00425     <span class="comment">// Track ttl xmitted bytes</span>
00426     byte_count += rc;
00427     data_idx++;
00428     
00429     <span class="comment">// Sleep</span>
00430     usleep(sample_delay);
00431     }
00432     
00433   thread_bailout:
00434 
00435     <span class="comment">// Figure elapsed time, to nearest second</span>
00436     t_delta = time(NULL) - t_start;
00437     <span class="keywordflow">if</span>(t_delta == 0) 
00438       t_delta = 1;
00439 
00440     flog_usr(FLOG_NOTICE, 0, me, 
00441          <span class="stringliteral">"Data thread exiting, %d points sent, appx %f kb/sec"</span>, 
00442          data_idx + 1, ((<span class="keywordtype">float</span>) (byte_count &gt;&gt; 10) / t_delta));
00443 
00444     <span class="comment">// Notify main thread</span>
00445     <a class="code" href="fake__daq_8c.html#a4">streaming_active</a> = <span class="keyword">false</span>;
00446 
00447     free(data_buf);
00448     
00449     <span class="keywordflow">return</span>(NULL);
00450 }
00451 
00452 
00453 <span class="comment">// ---------------------------------------------------------------------</span>
<a name="l00464"></a><a class="code" href="fake__daq_8c.html#a17">00464</a> <span class="comment"></span><span class="keywordtype">int</span> <a class="code" href="fake__daq_8c.html#a17">daq_do_work</a>(<span class="keyword">const</span> <span class="keywordtype">int</span> control_socket, <span class="keyword">const</span> <span class="keywordtype">int</span> data_socket)
00465 {
00466     <span class="keywordtype">char</span>              me[] = <span class="stringliteral">"daq_do_work"</span>;
00467     <span class="keywordtype">int</span>               rc, bytes_read, idx;
00468     time_t            req_timeout = 0;
00469     <span class="keywordtype">char</span>              cmd_buf[MAX_CMD_LEN] = <span class="stringliteral">""</span>;
00470     <span class="keywordtype">char</span>              daq_running[] = <span class="stringliteral">"Running"</span>;
00471     <span class="keywordtype">char</span>              unk_cmd[] = <span class="stringliteral">"Unknown command"</span>;
00472     <span class="keywordtype">char</span>              strm_ok[] = <span class="stringliteral">"Streaming data on data channel from port"</span>;
00473     <span class="keywordtype">char</span>              strm_stop[] = <span class="stringliteral">"Stopping data on data channel from port"</span>;
00474     pthread_t         data_thread;
00475     <span class="keywordtype">char</span>              *cptr = NULL;
00476     <span class="keywordtype">char</span>              *s_ptr = NULL;
00477     <span class="keywordtype">char</span>              reply_buf[128] = <span class="stringliteral">""</span>;
00478     <span class="keywordtype">int</span>               chan_id;
00479     <span class="keywordtype">char</span>              tok_buf[MAX_CMD_LEN] = <span class="stringliteral">""</span>;
00480     <span class="keywordtype">char</span>              channel_list[NUM_CHANNELS * 5] = <span class="stringliteral">""</span>;
00481     <span class="keywordtype">char</span>              unit_list[NUM_CHANNELS * 3] = <span class="stringliteral">""</span>;
00482     
00483     flog_usr(FLOG_PROGRESS, 0, me, <span class="stringliteral">"Waiting for request (indefinite wait)..."</span>);
00484     
00485     <span class="comment">// Build lists of channels and units, static</span>
00486     <span class="comment">// Uses reply_buf as a scratch buffer</span>
00487     <span class="keywordflow">for</span>(idx = 0; idx &lt; NUM_CHANNELS; idx++)
00488     {
00489     <span class="keywordflow">if</span>(idx &lt; (NUM_CHANNELS - 1))
00490     {
00491         sprintf(reply_buf, <span class="stringliteral">"%d,"</span>, idx);
00492         strcat(unit_list, <span class="stringliteral">"V, "</span>);  <span class="comment">// All units are volts</span>
00493     }
00494     <span class="keywordflow">else</span>
00495     {
00496         sprintf(reply_buf, <span class="stringliteral">"%d"</span>, idx);
00497         strcat(unit_list, <span class="stringliteral">"V"</span>);  <span class="comment">// All units are volts</span>
00498     }
00499     strcat(channel_list, reply_buf);
00500     }
00501     
00502     <span class="comment">// DDT</span>
00503     assert(strlen(channel_list) &lt; ((NUM_CHANNELS * 4) - 1));
00504 
00505     <span class="comment">// Read request from NSDS</span>
00506     bytes_read = tcp_nl_read(control_socket, cmd_buf, req_timeout);
00507     <span class="keywordflow">if</span>(bytes_read &lt;= 0)
00508     {
00509     flog_usr(FLOG_NOTICE, FL_ERR_TRANSCEIVE, me, 
00510          <span class="stringliteral">"Error on request read"</span>);
00511     <span class="keywordflow">return</span>(1);
00512     }
00513     
00514     <span class="comment">// Units are, of course, also fake</span>
00515     <span class="keywordflow">if</span>(strstr(cmd_buf, <span class="stringliteral">"list-units"</span>) != NULL)
00516     {
00517     flog_usr(FLOG_PROGRESS, 0, me, 
00518          <span class="stringliteral">"Got request for list of units"</span>);
00519 
00520     <span class="comment">// Send pre-built list</span>
00521     rc = tcp_nl_write(control_socket, unit_list);
00522     <span class="keywordflow">if</span>(rc != strlen(unit_list))
00523     {
00524         flog_usr(FLOG_ERROR, FL_ERR_TRANSCEIVE, me, 
00525              <span class="stringliteral">"Error writing status response on control channel"</span>);
00526         <span class="keywordflow">return</span>(2);
00527     }
00528     }
00529     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(strstr(cmd_buf, <span class="stringliteral">"list-channels"</span>) != NULL)
00530     {
00531     flog_usr(FLOG_PROGRESS, 0, me, 
00532          <span class="stringliteral">"Got request for channel list"</span>);
00533     
00534     <span class="comment">// Send pre-built list</span>
00535     rc = tcp_nl_write(control_socket, channel_list);
00536     <span class="keywordflow">if</span>(rc != strlen(channel_list))
00537     {
00538         flog_usr(FLOG_ERROR, FL_ERR_TRANSCEIVE, me, 
00539              <span class="stringliteral">"Error writing status response on control channel"</span>);
00540         <span class="keywordflow">return</span>(2);
00541     }
00542     }
00543     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(strstr(cmd_buf, <span class="stringliteral">"daq-status"</span>) != NULL)
00544     {
00545     flog_usr(FLOG_L2BUG, 0, me, 
00546          <span class="stringliteral">"Got status request '%s' OK, responding with '%s'"</span>,
00547          cmd_buf, daq_running);
00548 
00549     rc = tcp_nl_write(control_socket, daq_running);
00550     <span class="keywordflow">if</span>(rc != strlen(daq_running))
00551     {
00552         flog_usr(FLOG_ERROR, FL_ERR_TRANSCEIVE, me, 
00553              <span class="stringliteral">"Error writing status response on control channel"</span>);
00554         <span class="keywordflow">return</span>(2);
00555     }
00556     }
00557     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(strstr(cmd_buf, <span class="stringliteral">"open-port"</span>) != NULL)
00558     {
00559     <span class="comment">// Save a copy to munge</span>
00560     strcpy(tok_buf, cmd_buf);
00561     
00562     <span class="comment">// Start the parser, ignore first result ('open-port')</span>
00563     cptr = strtok_r(tok_buf, CMD_BUF_DELIM_CHARS, &amp;s_ptr);
00564 
00565     <span class="comment">// Now look for channel ID string</span>
00566     cptr = strtok_r(NULL, CMD_BUF_DELIM_CHARS, &amp;s_ptr);
00567 
00568     <span class="comment">// Cptr should now point to numeric argument</span>
00569     <span class="keywordflow">if</span>((cptr == NULL) || (chan_id_valid(cptr) == <span class="keyword">false</span>))
00570     {
00571         flog_usr(FLOG_ERROR, FL_ERR_BAD_PARAM, me,
00572              <span class="stringliteral">"Invalid data port '%s' on subscribe"</span>, cptr);
00573 
00574         <span class="comment">// Send out bad port message, blind send</span>
00575         sprintf(reply_buf, BAD_OPEN_CLOSE, cptr);
00576 
00577         flog_usr(FLOG_DEBUG, 0, me, 
00578              <span class="stringliteral">"Sending '%s' to NSDS"</span>, reply_buf);
00579         tcp_nl_write(control_socket, reply_buf);
00580         <span class="keywordflow">return</span>(0);
00581     }
00582 
00583     <span class="comment">// Single arg in channel ID</span>
00584     chan_id = atoi(cptr);
00585 
00586     <span class="comment">// Range check channel id for validity</span>
00587     <span class="keywordflow">if</span>((chan_id &lt; 0) || (chan_id &gt; (NUM_CHANNELS - 1)))
00588     {
00589         flog_usr(FLOG_ERROR, FL_ERR_BAD_VALUE, me,
00590              <span class="stringliteral">"Invalid channel ID '%s' in subscribe request"</span>,
00591              cptr);
00592 
00593         <span class="comment">// Send out bad port message, blind send</span>
00594         sprintf(reply_buf, BAD_OPEN_CLOSE, cptr);
00595         tcp_nl_write(control_socket, reply_buf);
00596         <span class="keywordflow">return</span>(0);
00597     }
00598 
00599     flog_usr(FLOG_L2BUG, 0, me,
00600          <span class="stringliteral">"Got data subscription request for channel %d"</span>, chan_id);
00601 
00602     <span class="keywordflow">if</span>(<a class="code" href="fake__daq_8c.html#a4">streaming_active</a> == <span class="keyword">false</span>)
00603     {
00604         flog_usr(FLOG_CL2BUG, 0, me, <span class="stringliteral">"Starting data thread"</span>);
00605         
00606         <span class="comment">// Set boolean semaphore for data thread</span>
00607         <a class="code" href="fake__daq_8c.html#a4">streaming_active</a> = <span class="keyword">true</span>;
00608         
00609         <span class="comment">// Clear out all old subscriptions</span>
00610         <span class="keywordflow">for</span>(idx = 0; idx &lt; NUM_CHANNELS; idx++)
00611         <a class="code" href="fake__daq_8c.html#a13">data_channel_flag</a>(idx, <span class="keyword">false</span>);
00612 
00613         <span class="comment">// Mark this one as active</span>
00614         rc = <a class="code" href="fake__daq_8c.html#a13">data_channel_flag</a>(chan_id, <span class="keyword">true</span>);
00615         <span class="keywordflow">if</span>(rc != 0)
00616         {
00617         flog_usr(FLOG_ERROR, FL_ERR_BAD_PARAM, me,
00618              <span class="stringliteral">"Error %d activating channel %d"</span>, rc, chan_id);
00619         <span class="keywordflow">return</span>(rc);
00620         }
00621 
00622         <span class="comment">// Fire up a thread</span>
00623         rc = pthread_create(&amp;data_thread, NULL, <a class="code" href="fake__daq_8c.html#a16">data_thread_main</a>,
00624                 (<span class="keywordtype">void</span> *) &amp;data_socket);
00625         <span class="keywordflow">if</span>(rc != 0)
00626         {
00627         flog_usr(FLOG_ERROR, FL_ERR_SYSTEM, me,
00628              <span class="stringliteral">"Error on thread creation!"</span>);
00629         <span class="keywordflow">return</span>(3);
00630         }
00631         
00632         <span class="comment">// Let 'er rip</span>
00633         pthread_detach(data_thread);
00634         pthread_setconcurrency(2);
00635         
00636         flog_usr(FLOG_CL2BUG, 0, me, <span class="stringliteral">"Data thread started OK"</span>);
00637     }
00638     <span class="keywordflow">else</span> <span class="comment">// Streaming already up, just add new channel</span>
00639     {
00640         flog_usr(FLOG_CL4BUG, 0, me, <span class="stringliteral">"adding to active list"</span>);
00641 
00642         <span class="comment">// Mark as active</span>
00643         rc = <a class="code" href="fake__daq_8c.html#a13">data_channel_flag</a>(chan_id, <span class="keyword">true</span>);
00644         <span class="keywordflow">if</span>(rc != 0)
00645         {
00646         flog_usr(FLOG_ERROR, FL_ERR_BAD_PARAM, me,
00647              <span class="stringliteral">"Error %d activating channel %d"</span>, rc, chan_id);
00648         <span class="keywordflow">return</span>(rc);
00649         }
00650     }
00651 
00652     <span class="comment">// Append channel ID</span>
00653     sprintf(reply_buf, <span class="stringliteral">"%s %d"</span>, strm_ok, chan_id);
00654     
00655     <span class="comment">// Ack to driver, on _control_ channel</span>
00656     rc = tcp_nl_write(control_socket, reply_buf);
00657     <span class="keywordflow">if</span>(rc != strlen(reply_buf))
00658     {
00659         flog_usr(FLOG_ERROR, FL_ERR_TRANSCEIVE, me, 
00660              <span class="stringliteral">"Error writing response on control channel"</span>);
00661         <span class="keywordflow">return</span>(2);
00662     }
00663     }
00664     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(strstr(cmd_buf, <span class="stringliteral">"close-port"</span>) != NULL)
00665     {
00666     <span class="comment">// Save a copy to munge</span>
00667     strcpy(tok_buf, cmd_buf);
00668     
00669     <span class="comment">// Start the parser, ignore first result ('close-port')</span>
00670     cptr = strtok_r(tok_buf, CMD_BUF_DELIM_CHARS, &amp;s_ptr);
00671 
00672     <span class="comment">// Find channel ID string</span>
00673     cptr = strtok_r(NULL, CMD_BUF_DELIM_CHARS, &amp;s_ptr);
00674 
00675     <span class="comment">// Cptr should now point to numeric argument</span>
00676     <span class="keywordflow">if</span>((cptr == NULL) || (chan_id_valid(cptr) == <span class="keyword">false</span>))
00677     {
00678         flog_usr(FLOG_ERROR, FL_ERR_BAD_PARAM, me,
00679              <span class="stringliteral">"Invalid data port '%s' on unsubscribe"</span>, cptr);
00680 
00681         sprintf(reply_buf, BAD_OPEN_CLOSE, cptr);
00682         flog_usr(FLOG_DEBUG, 0, me, 
00683              <span class="stringliteral">"Sending '%s' to NSDS"</span>, reply_buf);
00684         tcp_nl_write(control_socket, reply_buf);
00685         <span class="keywordflow">return</span>(0);
00686     }
00687 
00688     <span class="comment">// Single arg in channel ID</span>
00689     chan_id = atoi(cptr);
00690 
00691     <span class="keywordflow">if</span>((chan_id &lt; 0) || (chan_id &gt; (NUM_CHANNELS - 1)))
00692     {
00693         flog_usr(FLOG_ERROR, FL_ERR_BAD_VALUE, me,
00694              <span class="stringliteral">"Invalid channel ID '%s' in unsubscribe request"</span>,
00695              cptr);
00696 
00697         <span class="comment">// Send out bad port message, blind send</span>
00698         sprintf(reply_buf, BAD_OPEN_CLOSE, cptr);
00699         tcp_nl_write(control_socket, reply_buf);
00700         <span class="keywordflow">return</span>(0);
00701     }
00702 
00703     flog_usr(FLOG_NOTICE, 0, me,
00704          <span class="stringliteral">"Got port close request on channel %d, %d active"</span>, 
00705          chan_id, <a class="code" href="fake__daq_8c.html#a11">data_active_count</a>()); 
00706 
00707     <span class="comment">// Mark as inactive</span>
00708     rc = <a class="code" href="fake__daq_8c.html#a13">data_channel_flag</a>(chan_id, <span class="keyword">false</span>);
00709 
00710     <span class="comment">// Append channel ID</span>
00711     sprintf(reply_buf, <span class="stringliteral">"%s %d"</span>, strm_stop, chan_id);
00712 
00713     <span class="comment">// Ack to driver, on _control_ channel</span>
00714     rc = tcp_nl_write(control_socket, reply_buf);
00715     <span class="keywordflow">if</span>(rc != strlen(reply_buf))
00716     {
00717         flog_usr(FLOG_ERROR, FL_ERR_TRANSCEIVE, me,
00718              <span class="stringliteral">"Error writing response on control channel"</span>);
00719         <span class="keywordflow">return</span>(2);
00720     }
00721     }
00722     <span class="keywordflow">else</span> <span class="comment">// all other commands</span>
00723     {
00724     flog_usr(FLOG_ERROR, FL_ERR_NOCANDO, me, 
00725          <span class="stringliteral">"Got unknown command '%s'"</span>, cmd_buf);
00726 
00727     <span class="comment">// Reply with "Unknown command 'command'"</span>
00728     sprintf(reply_buf, <span class="stringliteral">"%s '%s'"</span>, unk_cmd, cmd_buf);
00729     rc = tcp_nl_write(control_socket, reply_buf);
00730     <span class="keywordflow">if</span>(rc != strlen(reply_buf))
00731     {
00732         flog_usr(FLOG_ERROR, FL_ERR_TRANSCEIVE, me, 
00733              <span class="stringliteral">"Error writing response on control channel"</span>);
00734         <span class="keywordflow">return</span>(2);
00735     }
00736     }
00737 
00738     <span class="comment">// Make super-sure response is sent</span>
00739     fsync(control_socket);
00740 
00741     flog_usr(FLOG_L4BUG, 0, me, <span class="stringliteral">"done"</span>);
00742     
00743     <span class="keywordflow">return</span>(0);
00744 }
00745 
00746 
00747 <span class="comment">// ---------------------------------------------------------------------</span>
<a name="l00757"></a><a class="code" href="fake__daq_8c.html#a18">00757</a> <span class="comment"></span><span class="keywordtype">void</span> <a class="code" href="fake__daq_8c.html#a18">daq_main_loop</a>(<span class="keyword">const</span> <span class="keywordtype">int</span> daq_port)
00758 {
00759     <span class="keywordtype">char</span>               me[] = <span class="stringliteral">"daq_main_loop"</span>;
00760     <span class="keywordtype">int</span>                ctrl_master, data_master;
00761     <span class="keywordtype">int</span>                control_socket, data_socket;
00762     <span class="keyword">struct </span>sockaddr_in fsin;
00763     <span class="keywordtype">int</span>                addr_len = <span class="keyword">sizeof</span>(fsin);
00764     <span class="keywordtype">bool</span>               do_init = <span class="keyword">false</span>;
00765     <span class="keywordtype">int</span>                cmd_count = 0;
00766 
00767     <span class="comment">// Set up master control socket</span>
00768     ctrl_master = tcp_socket_make(daq_port, <a class="code" href="fake__daq_8c.html#a1">TCP_Q_LEN</a>);
00769     <span class="keywordflow">if</span>(ctrl_master &lt;= 0)
00770     <span class="keywordflow">return</span>;
00771         
00772     <span class="comment">// Set up master data socket</span>
00773     data_master = tcp_socket_make(daq_port + 1, <a class="code" href="fake__daq_8c.html#a1">TCP_Q_LEN</a>);
00774     <span class="keywordflow">if</span>(data_master &lt;= 0)
00775     <span class="keywordflow">return</span>;
00776 
00777     <span class="comment">// ------------------------</span>
00778     <span class="comment">// Main loop, runs until control-c</span>
00779     <span class="keywordflow">while</span>(<a class="code" href="fake__daq_8c.html#a2">control_break</a> == <span class="keyword">false</span>)
00780     {
00781     <span class="comment">// If restarting, close all first</span>
00782     <span class="keywordflow">if</span>(do_init == <span class="keyword">true</span>)
00783     {
00784         flog_usr(FLOG_PROGRESS, 0, me, 
00785              <span class="stringliteral">"Re-init DAQ, closing connection"</span>);
00786 
00787         tcp_close(control_socket);
00788         tcp_close(data_socket);
00789 
00790         <span class="comment">// Tell data thread to exit</span>
00791         <a class="code" href="fake__daq_8c.html#a4">streaming_active</a> = <span class="keyword">false</span>;
00792     }
00793     <span class="keywordflow">else</span> <span class="comment">// Set flag for subsequent loops</span>
00794         do_init = <span class="keyword">true</span>;
00795     
00796     
00797     <span class="comment">// Off we go</span>
00798     flog_usr(FLOG_L1BUG, 0, me, <span class="stringliteral">"Waiting for driver control connection..."</span>);
00799     
00800     control_socket = accept(ctrl_master, 
00801                    (<span class="keyword">struct</span> sockaddr *) &amp;fsin, &amp;addr_len);
00802     <span class="comment">// Check who connected</span>
00803     flog_usr(FLOG_CL1BUG, 0, me, 
00804          <span class="stringliteral">"Driver '%s' connected to control channel"</span>, 
00805          tcp_peername(control_socket));
00806 
00807     flog_usr(FLOG_L1BUG, 0, me, <span class="stringliteral">"Waiting for driver data connection..."</span>);
00808     
00809     data_socket = accept(data_master, 
00810                  (<span class="keyword">struct</span> sockaddr *) &amp;fsin, &amp;addr_len);
00811 
00812     <span class="comment">// Save into struct for signal handler</span>
00813     <a class="code" href="fake__daq_8c.html#a10">curr_connection</a>.<a class="code" href="structconnection__fds.html#o0">control_socket</a> = control_socket;
00814     <a class="code" href="fake__daq_8c.html#a10">curr_connection</a>.<a class="code" href="structconnection__fds.html#o1">data_socket</a> = data_socket;
00815 
00816     <span class="comment">// Check who connected</span>
00817     flog_usr(FLOG_CL1BUG, 0, me, 
00818          <span class="stringliteral">"Driver '%s' connected to data channel"</span>, 
00819          tcp_peername(data_socket));
00820 
00821     <span class="comment">/* Call the routine to read and respond</span>
00822 <span class="comment">       If an error, we will re-init the TCP connections.</span>
00823 <span class="comment">    */</span>
00824     <span class="keywordflow">while</span>(<a class="code" href="fake__daq_8c.html#a17">daq_do_work</a>(control_socket, data_socket) == 0)
00825     {
00826         flog_usr(FLOG_L2BUG, 0, me, 
00827              <span class="stringliteral">"Command #%d completed OK"</span>, cmd_count++);
00828     }
00829     }
00830     
00831     <span class="keywordflow">return</span>;
00832 }
00833     
00834 <span class="comment">// ---------------------------------------------------------------------</span>
<a name="l00848"></a><a class="code" href="fake__daq_8c.html#a19">00848</a> <span class="comment"></span><span class="keywordtype">int</span> <a class="code" href="fake__daq_8c.html#a19">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
00849 {
00850     <span class="keywordtype">char</span>          me[] = <span class="stringliteral">"main"</span>;
00851     uint16_t      daq_port = 0;
00852     <span class="keywordtype">int</span>           help_flag = 0;
00853     <span class="keywordtype">int</span>           idx, rc;
00854     
00855     <span class="keyword">struct </span>option long_options[] = 
00856     {
00857         {<span class="stringliteral">"port"</span>, required_argument, 0, <span class="charliteral">'p'</span>},
00858         {<span class="stringliteral">"rate"</span>, required_argument, 0, <span class="charliteral">'r'</span>},
00859         {<span class="stringliteral">"help"</span>, no_argument, &amp;help_flag, <span class="charliteral">'h'</span>},
00860         {0, 0, 0, 0}
00861     };
00862     
00863     <span class="comment">// Set defaults before (possibly) overriden by command line</span>
00864     daq_port = <a class="code" href="fake__daq_8c.html#a0">DAQ_PORT</a>;
00865     <a class="code" href="fake__daq_8c.html#a3">sample_rate</a> = 20.0;
00866 
00867     <span class="comment">// Set logging options</span>
00868     flog_set_report(FLOG_L3BUG, FLOG_QUIET, FLOG_QUIET);
00869     flog_set_style(0x2019, 0x0038, 0x6008);    
00870 
00871     pthread_mutex_init(&amp;<a class="code" href="fake__daq_8c.html#a9">chan_struct</a>.mutex, NULL);
00872     
00873     <span class="comment">// Parse command line with getopt_long</span>
00874     <span class="keywordflow">while</span>(1)
00875     {
00876     rc = getopt_long(argc, argv, <span class="stringliteral">"p:r:h"</span>,
00877               long_options, &amp;idx);
00878     <span class="keywordflow">if</span>(rc == -1)
00879         <span class="keywordflow">break</span>;
00880     
00881     <span class="keywordflow">switch</span>(rc)
00882     {
00883       <span class="keywordflow">case</span> 0:
00884         <span class="comment">/* If this option set a flag, do nothing else now. */</span>
00885         <span class="keywordflow">break</span>;
00886         
00887       <span class="keywordflow">case</span> <span class="charliteral">'p'</span>:
00888         daq_port = atoi(optarg);
00889         flog_usr(FLOG_NOTICE, 0, me, 
00890              <span class="stringliteral">"Setting port to %d"</span>, daq_port);
00891         <span class="keywordflow">break</span>;
00892         
00893       <span class="keywordflow">case</span> <span class="charliteral">'r'</span>:
00894         <a class="code" href="fake__daq_8c.html#a3">sample_rate</a> = atof(optarg);
00895         
00896         flog_usr(FLOG_NOTICE, 0, me,
00897              <span class="stringliteral">"Setting sample rate to %f Hz"</span>, <a class="code" href="fake__daq_8c.html#a3">sample_rate</a>);
00898         <span class="keywordflow">break</span>;
00899         
00900       <span class="keywordflow">case</span> <span class="charliteral">'?'</span>:
00901         <span class="comment">/* getopt_long already printed an error message. */</span>
00902         <span class="keywordflow">break</span>;  
00903     
00904       <span class="keywordflow">case</span> <span class="charliteral">'h'</span>:
00905         help_flag = 1;
00906         <span class="keywordflow">break</span>;
00907         
00908       <span class="keywordflow">default</span>:
00909         flog_usr(FLOG_ERROR, FL_ERR_SYSTEM, me, 
00910              <span class="stringliteral">"Unreachable case in getopt_long parse"</span>);
00911         exit(1);
00912     }
00913     }
00914     
00915     <span class="keywordflow">if</span>(help_flag != 0)
00916     {
00917         print_args(long_options);
00918         <span class="keywordflow">return</span>(1);
00919     }
00920 
00921     flog_usr(FLOG_NOTICE, 0, me, 
00922          <span class="stringliteral">"Compiled for %d data channels max"</span>, NUM_CHANNELS);
00923     
00924     <span class="comment">// Signal handler</span>
00925     flog_usr(FLOG_NOTICE, 0, me, <span class="stringliteral">"Installing signal handler"</span>);
00926     <a class="code" href="fake__daq_8c.html#a2">control_break</a> = <span class="keyword">false</span>;
00927     signal(SIGINT, <a class="code" href="fake__daq_8c.html#a15">sighandler</a>);
00928     signal(SIGPIPE, <a class="code" href="fake__daq_8c.html#a15">sighandler</a>);
00929 
00930     <span class="comment">// Call main routine</span>
00931     <a class="code" href="fake__daq_8c.html#a18">daq_main_loop</a>(daq_port);
00932 
00933     <span class="comment">// Bail</span>
00934     flog_usr(FLOG_NOTICE, 0, me, <span class="stringliteral">"Done"</span>);
00935     <span class="keywordflow">return</span>(0);
00936 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Thu Feb 24 13:34:30 2005 for Fake DAQ for NEESgrid by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
